"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _moment = _interopRequireDefault(require("moment"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _defineProperty(obj, key, value) { if (key in obj) { Object.defineProperty(obj, key, { value: value, enumerable: true, configurable: true, writable: true }); } else { obj[key] = value; } return obj; }

function padDigits(number, digits) {
  return Array(Math.max(digits - String(number).length + 1, 0)).join('0') + number;
}

class BroadcastDb {
  constructor(bp) {
    _defineProperty(this, "knex", void 0);

    this.knex = bp.database;
  }

  initialize() {
    return this.knex.createTableIfNotExists('broadcast_schedules', table => {
      table.increments('id').primary();
      table.string('botId');
      table.string('date_time');
      table.timestamp('ts');
      table.string('text');
      table.string('type');
      table.boolean('outboxed');
      table.boolean('errored');
      table.integer('total_count');
      table.integer('sent_count');
      table.timestamp('created_on');
      table.string('filters');
    }).then(() => {
      return this.knex.createTableIfNotExists('broadcast_outbox', table => {
        table.integer('scheduleId').references('broadcast_schedules.id').onDelete('CASCADE');
        table.integer('userId').unsigned().notNullable().references('id').inTable('srv_channel_users');
        table.primary(['scheduleId', 'userId']);
        table.string('botId');
        table.timestamp('ts');
      });
    });
  }

  async addSchedule({
    botId,
    date,
    time,
    timezone,
    content,
    type,
    filters
  }) {
    const dateTime = date + ' ' + time;
    let ts = undefined;

    if (timezone) {
      ts = (0, _moment.default)(new Date(dateTime + ' ' + timezone)).toDate();
    }

    const row = {
      botId,
      date_time: dateTime,
      ts: ts ? this.knex.date.format(ts) : undefined,
      text: content,
      type: type,
      outboxed: false,
      errored: false,
      total_count: 0,
      sent_count: 0,
      created_on: this.knex.date.now(),
      filters: JSON.stringify(filters)
    };
    return this.knex('broadcast_schedules').insert(row);
  }

  async updateSchedule({
    id,
    botId,
    date,
    time,
    timezone,
    content,
    type,
    filters
  }) {
    const dateTime = date + ' ' + time;
    let ts = undefined;

    if (timezone) {
      ts = (0, _moment.default)(new Date(dateTime + ' ' + timezone)).toDate();
    }

    const row = {
      date_time: dateTime,
      ts: ts ? this.knex.date.format(ts) : undefined,
      text: content,
      type: type,
      filters: JSON.stringify(filters)
    };
    await this.knex('broadcast_schedules').where({
      id,
      botId,
      outboxed: this.knex.bool.false()
    }).update(row);
  }

  async deleteSchedule(id) {
    await this.knex('broadcast_schedules').where({
      id
    }).delete();
    await this.knex('broadcast_outbox').where({
      scheduleId: id
    }).delete();
  }

  async listSchedules(botId) {
    return this.knex('broadcast_schedules').where({
      botId
    });
  }

  async getBroadcastSchedulesByTime(botId, upcomingFixedTime, upcomingVariableTime) {
    return this.knex('broadcast_schedules').where({
      botId,
      outboxed: this.knex.bool.false()
    }).andWhere(function () {
      this.where(function () {
        this.whereNotNull('ts').andWhere(upcomingFixedTime);
      }).orWhere(function () {
        this.whereNull('ts').andWhere(upcomingVariableTime);
      });
    });
  }

  async getUsersTimezone() {
    const attrs = await this.knex('srv_channel_users').select('attributes');
    const timezones = attrs.map(({
      attributes: {
        timezone
      }
    }) => timezone);
    return [...new Set(timezones)];
  }

  setBroadcastOutbox(botId, schedule, tz) {
    const initialTz = tz;
    const sign = Number(tz) >= 0 ? '+' : '-';
    tz = padDigits(Math.abs(Number(tz)), 2);
    const relTime = (0, _moment.default)(`${schedule['date_time']}${sign}${tz}`, 'YYYY-MM-DD HH:mmZ').toDate();
    const adjustedTime = this.knex.date.format(schedule['ts'] ? schedule['ts'] : relTime); // const whereClause = _.isNil(initialTz)
    //  ? 'where attributes->timezone IS NULL'
    //  : 'where attributes->>timezone = :initialTz'

    const sql = `insert into broadcast_outbox ("userId", "scheduleId", "botId", "ts")
      select userId, :scheduleId, :botId, :adjustedTime
      from (
        select id as userId
        from srv_channel_users
      ) as q1`;
    return this.knex.raw(sql, {
      scheduleId: schedule['id'],
      adjustedTime,
      initialTz,
      botId
    }).then();
  }

  async getOutboxCount(botId, schedule) {
    const result = await this.knex('broadcast_outbox').where({
      botId,
      scheduleId: schedule.id
    }).count('* as qty').first().then(result => result.qty);
    return typeof result === 'number' ? result : parseInt(result);
  }

  updateTotalCount(schedule, count) {
    return this.knex('broadcast_schedules').where({
      id: schedule.id
    }).update({
      outboxed: this.knex.bool.true(),
      total_count: count
    });
  }

  async getBroadcastOutbox(botId) {
    return this.knex('broadcast_outbox').whereRaw('broadcast_outbox.ts < ?', [this.knex.date.now()]).andWhere('broadcast_outbox.botId', botId).join('srv_channel_users', 'srv_channel_users.id', 'broadcast_outbox.userId').join('broadcast_schedules', 'scheduleId', 'broadcast_schedules.id').limit(1000).select(['srv_channel_users.user_id as userId', 'srv_channel_users.channel as platform', 'broadcast_schedules.text as text', 'broadcast_schedules.type as type', 'broadcast_schedules.id as scheduleId', 'broadcast_schedules.filters as filters', 'broadcast_outbox.ts as sendTime', 'broadcast_outbox.userId as scheduleUser']);
  }

  async deleteBroadcastOutbox(userId, scheduleId) {
    return this.knex('broadcast_outbox').where({
      userId,
      scheduleId
    }).delete();
  }

  async deleteBroadcastOutboxById(scheduleId) {
    return this.knex('broadcast_outbox').where({
      scheduleId
    }).delete();
  }

  async increaseBroadcastSentCount(id) {
    return this.knex('broadcast_schedules').where({
      id
    }).update({
      sent_count: this.knex.raw('sent_count + 1')
    });
  }

  async updateErrorField(scheduleId) {
    return this.knex('broadcast_schedules').where({
      id: scheduleId
    }).update({
      errored: this.knex.bool.true()
    });
  }

}

exports.default = BroadcastDb;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRiLnRzIl0sIm5hbWVzIjpbInBhZERpZ2l0cyIsIm51bWJlciIsImRpZ2l0cyIsIkFycmF5IiwiTWF0aCIsIm1heCIsIlN0cmluZyIsImxlbmd0aCIsImpvaW4iLCJCcm9hZGNhc3REYiIsImNvbnN0cnVjdG9yIiwiYnAiLCJrbmV4IiwiZGF0YWJhc2UiLCJpbml0aWFsaXplIiwiY3JlYXRlVGFibGVJZk5vdEV4aXN0cyIsInRhYmxlIiwiaW5jcmVtZW50cyIsInByaW1hcnkiLCJzdHJpbmciLCJ0aW1lc3RhbXAiLCJib29sZWFuIiwiaW50ZWdlciIsInRoZW4iLCJyZWZlcmVuY2VzIiwib25EZWxldGUiLCJ1bnNpZ25lZCIsIm5vdE51bGxhYmxlIiwiaW5UYWJsZSIsImFkZFNjaGVkdWxlIiwiYm90SWQiLCJkYXRlIiwidGltZSIsInRpbWV6b25lIiwiY29udGVudCIsInR5cGUiLCJmaWx0ZXJzIiwiZGF0ZVRpbWUiLCJ0cyIsInVuZGVmaW5lZCIsIkRhdGUiLCJ0b0RhdGUiLCJyb3ciLCJkYXRlX3RpbWUiLCJmb3JtYXQiLCJ0ZXh0Iiwib3V0Ym94ZWQiLCJlcnJvcmVkIiwidG90YWxfY291bnQiLCJzZW50X2NvdW50IiwiY3JlYXRlZF9vbiIsIm5vdyIsIkpTT04iLCJzdHJpbmdpZnkiLCJpbnNlcnQiLCJ1cGRhdGVTY2hlZHVsZSIsImlkIiwid2hlcmUiLCJib29sIiwiZmFsc2UiLCJ1cGRhdGUiLCJkZWxldGVTY2hlZHVsZSIsImRlbGV0ZSIsInNjaGVkdWxlSWQiLCJsaXN0U2NoZWR1bGVzIiwiZ2V0QnJvYWRjYXN0U2NoZWR1bGVzQnlUaW1lIiwidXBjb21pbmdGaXhlZFRpbWUiLCJ1cGNvbWluZ1ZhcmlhYmxlVGltZSIsImFuZFdoZXJlIiwid2hlcmVOb3ROdWxsIiwib3JXaGVyZSIsIndoZXJlTnVsbCIsImdldFVzZXJzVGltZXpvbmUiLCJhdHRycyIsInNlbGVjdCIsInRpbWV6b25lcyIsIm1hcCIsImF0dHJpYnV0ZXMiLCJTZXQiLCJzZXRCcm9hZGNhc3RPdXRib3giLCJzY2hlZHVsZSIsInR6IiwiaW5pdGlhbFR6Iiwic2lnbiIsIk51bWJlciIsImFicyIsInJlbFRpbWUiLCJhZGp1c3RlZFRpbWUiLCJzcWwiLCJyYXciLCJnZXRPdXRib3hDb3VudCIsInJlc3VsdCIsImNvdW50IiwiZmlyc3QiLCJxdHkiLCJwYXJzZUludCIsInVwZGF0ZVRvdGFsQ291bnQiLCJ0cnVlIiwiZ2V0QnJvYWRjYXN0T3V0Ym94Iiwid2hlcmVSYXciLCJsaW1pdCIsImRlbGV0ZUJyb2FkY2FzdE91dGJveCIsInVzZXJJZCIsImRlbGV0ZUJyb2FkY2FzdE91dGJveEJ5SWQiLCJpbmNyZWFzZUJyb2FkY2FzdFNlbnRDb3VudCIsInVwZGF0ZUVycm9yRmllbGQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7QUFFQTs7Ozs7O0FBSUEsU0FBU0EsU0FBVCxDQUFtQkMsTUFBbkIsRUFBMkJDLE1BQTNCLEVBQW1DO0FBQ2pDLFNBQU9DLEtBQUssQ0FBQ0MsSUFBSSxDQUFDQyxHQUFMLENBQVNILE1BQU0sR0FBR0ksTUFBTSxDQUFDTCxNQUFELENBQU4sQ0FBZU0sTUFBeEIsR0FBaUMsQ0FBMUMsRUFBNkMsQ0FBN0MsQ0FBRCxDQUFMLENBQXVEQyxJQUF2RCxDQUE0RCxHQUE1RCxJQUFtRVAsTUFBMUU7QUFDRDs7QUFFYyxNQUFNUSxXQUFOLENBQWtCO0FBRy9CQyxFQUFBQSxXQUFXLENBQUNDLEVBQUQsRUFBaUI7QUFBQTs7QUFDMUIsU0FBS0MsSUFBTCxHQUFZRCxFQUFFLENBQUNFLFFBQWY7QUFDRDs7QUFFREMsRUFBQUEsVUFBVSxHQUFHO0FBQ1gsV0FBTyxLQUFLRixJQUFMLENBQ0pHLHNCQURJLENBQ21CLHFCQURuQixFQUMwQ0MsS0FBSyxJQUFJO0FBQ3REQSxNQUFBQSxLQUFLLENBQUNDLFVBQU4sQ0FBaUIsSUFBakIsRUFBdUJDLE9BQXZCO0FBQ0FGLE1BQUFBLEtBQUssQ0FBQ0csTUFBTixDQUFhLE9BQWI7QUFDQUgsTUFBQUEsS0FBSyxDQUFDRyxNQUFOLENBQWEs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TkgsQ0FBUDtBQWdCRDs7QUFFRCxRQUFNMkIscUJBQU4sQ0FBNEJDLE1BQTVCLEVBQTRDdkMsVUFBNUMsRUFBK0U7QUFDN0UsV0FBTyxLQUFLbkQsSUFBTCxDQUFVLGtCQUFWLEVBQ0o2QyxLQURJLENBQ0U7QUFBRTZDLE1BQUFBLE1BQUY7QUFBVXZDLE1BQUFBO0FBQVYsS0FERixFQUVKRCxNQUZJLEVBQVA7QUFHRDs7QUFFRCxRQUFNeUMseUJBQU4sQ0FBZ0N4QyxVQUFoQyxFQUFtRTtBQUNqRSxXQUFPLEtBQUtuRCxJQUFMLENBQVUsa0JBQVYsRUFDSjZDLEtBREksQ0FDRTtBQUFFTSxNQUFBQTtBQUFGLEtBREYsRUFFSkQsTUFGSSxFQUFQO0FBR0Q7O0FBRUQsUUFBTTBDLDBCQUFOLENBQWlDaEQsRUFBakMsRUFBNEQ7QUFDMUQsV0FBTyxLQUFLNUMsSUFBTCxDQUFVLHFCQUFWLEVBQ0o2QyxLQURJLENBQ0U7QUFBRUQsTUFBQUE7QUFBRixLQURGLEVBRUpJLE1BRkksQ0FFRztBQUFFWCxNQUFBQSxVQUFVLEVBQUUsS0FBS3JDLElBQUwsQ0FBVTZFLEdBQVYsQ0FBYyxnQkFBZDtBQUFkLEtBRkgsQ0FBUDtBQUdEOztBQUVELFFBQU1nQixnQkFBTixDQUF1QjFDLFVBQXZCLEVBQTBEO0FBQ3hELFdBQU8sS0FBS25ELElBQUwsQ0FBVSxxQkFBVixFQUNKNkMsS0FESSxDQUNFO0FBQUVELE1BQUFBLEVBQUUsRUFBRU87QUFBTixLQURGLEVBRUpILE1BRkksQ0FFRztBQUFFYixNQUFBQSxPQUFPLEVBQUUsS0FBS25DLElBQUwsQ0FBVThDLElBQVYsQ0FBZXVDLElBQWY7QUFBWCxLQUZILENBQVA7QUFHRDs7QUEvTThCIiwic291cmNlUm9vdCI6Ii9tbnQvRG9jdW1lbnRzL1Byb2pldHMvQm90UHJlc3MvYm90cHJlc3MvbW9kdWxlcy9icm9hZGNhc3Qvc3JjL2JhY2tlbmQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgKiBhcyBzZGsgZnJvbSAnYm90cHJlc3Mvc2RrJ1xuaW1wb3J0IF8gZnJvbSAnbG9kYXNoJ1xuaW1wb3J0IG1vbWVudCBmcm9tICdtb21lbnQnXG5cbmltcG9ydCB7IEJyb2FkY2FzdCwgU2NoZWR1bGUsIFNjaGVkdWxlUm93IH0gZnJvbSAnLi90eXBpbmdzJ1xuXG5mdW5jdGlvbiBwYWREaWdpdHMobnVtYmVyLCBkaWdpdHMpIHtcbiAgcmV0dXJuIEFycmF5KE1hdGgubWF4KGRpZ2l0cyAtIFN0cmluZyhudW1iZXIpLmxlbmd0aCArIDEsIDApKS5qb2luKCcwJykgKyBudW1iZXJcbn1cblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgQnJvYWRjYXN0RGIge1xuICBrbmV4OiBzZGsuS25leEV4dGVuZGVkXG5cbiAgY29uc3RydWN0b3IoYnA6IHR5cGVvZiBzZGspIHtcbiAgICB0aGlzLmtuZXggPSBicC5kYXRhYmFzZVxuICB9XG5cbiAgaW5pdGlhbGl6ZSgpIHtcbiAgICByZXR1cm4gdGhpcy5rbmV4XG4gICAgICAuY3JlYXRlVGFibGVJZk5vdEV4aXN0cygnYnJvYWRjYXN0X3NjaGVkdWxlcycsIHRhYmxlID0+IHtcbiAgICAgICAgdGFibGUuaW5jcmVtZW50cygnaWQnKS5wcmltYXJ5KClcbiAgICAgICAgdGFibGUuc3RyaW5nKCdib3RJZCcpXG4gICAgICAgIHRhYmxlLnN0cmluZygnZGF0ZV90aW1lJylcbiAgICAgICAgdGFibGUudGltZXN0YW1wKCd0cycpXG4gICAgICAgIHRhYmxlLnN0cmluZygndGV4dCcpXG4gICAgICAgIHRhYmxlLnN0cmluZygndHlwZScpXG4gICAgICAgIHRhYmxlLmJvb2xlYW4oJ291dGJveGVkJylcbiAgICAgICAgdGFibGUuYm9vbGVhbignZXJyb3JlZCcpXG4gICAgICAgIHRhYmxlLmludGVnZXIoJ3RvdGFsX2NvdW50JylcbiAgICAgICAgdGFibGUuaW50ZWdlcignc2VudF9jb3VudCcpXG4gICAgICAgIHRhYmxlLnRpbWVzdGFtcCgnY3JlYXRlZF9vbicpXG4gICAgICAgIHRhYmxlLnN0cmluZygnZmlsdGVycycpXG4gICAgICB9KVxuICAgICAgLnRoZW4oKCkgPT4ge1xuICAgICAgICByZXR1cm4gdGhpcy5rbmV4LmNyZWF0ZVRhYmxlSWZOb3RFeGlzdHMoJ2Jyb2FkY2FzdF9vdXRib3gnLCB0YWJsZSA9PiB7XG4gICAgICAgICAgdGFibGVcbiAgICAgICAgICAgIC5pbnRlZ2VyKCdzY2hlZHVsZUlkJylcbiAgICAgICAgICAgIC5yZWZlcmVuY2VzKCdicm9hZGNhc3Rfc2NoZWR1bGVzLmlkJylcbiAgICAgICAgICAgIC5vbkRlbGV0ZSgnQ0FTQ0FERScpXG4gICAgICAgICAgdGFibGVcbiAgICAgICAgICAgIC5pbnRlZ2VyKCd1c2VySWQnKVxuICAgICAgICAgICAgLnVuc2lnbmVkKClcbiAgICAgICAgICAgIC5ub3ROdWxsYWJsZSgpXG4gICAgICAgICAgICAucmVmZXJlbmNlcygnaWQnKVxuICAgICAgICAgICAgLmluVGFibGUoJ3Nydl9jaGFubmVsX3VzZXJzJylcbiAgICAgICAgICB0YWJsZS5wcmltYXJ5KFsnc2NoZWR1bGVJZCcsICd1c2VySWQnXSlcbiAgICAgICAgICB0YWJsZS5zdHJpbmcoJ2JvdElkJylcbiAgICAgICAgICB0YWJsZS50aW1lc3RhbXAoJ3RzJylcbiAgICAgICAgfSlcbiAgICAgIH0pXG4gIH1cblxuICBhc3luYyBhZGRTY2hlZHVsZSh7IGJvdElkLCBkYXRlLCB0aW1lLCB0aW1lem9uZSwgY29udGVudCwgdHlwZSwgZmlsdGVycyB9OiBTY2hlZHVsZSk6IFByb21pc2U8U2NoZWR1bGVSb3c+IHtcbiAgICBjb25zdCBkYXRlVGltZSA9IGRhdGUgKyAnICcgKyB0aW1lXG4gICAgbGV0IHRzID0gdW5kZWZpbmVkXG5cbiAgICBpZiAodGltZXpvbmUpIHtcbiAgICAgIHRzID0gbW9tZW50KG5ldyBEYXRlKGRhdGVUaW1lICsgJyAnICsgdGltZXpvbmUpKS50b0RhdGUoKVxuICAgIH1cblxuICAgIGNvbnN0IHJvdzogU2NoZWR1bGVSb3cgPSB7XG4gICAgICBib3RJZCxcbiAgICAgIGRhdGVfdGltZTogZGF0ZVRpbWUsXG4gICAgICB0czogdHMgPyB0aGlzLmtuZXguZGF0ZS5mb3JtYXQodHMpIDogdW5kZWZpbmVkLFxuICAgICAgdGV4dDogY29udGVudCxcbiAgICAgIHR5cGU6IHR5cGUsXG4gICAgICBvdXRib3hlZDogZmFsc2UsXG4gICAgICBlcnJvcmVkOiBmYWxzZSxcbiAgICAgIHRvdGFsX2NvdW50OiAwLFxuICAgICAgc2VudF9jb3VudDogMCxcbiAgICAgIGNyZWF0ZWRfb246IHRoaXMua25leC5kYXRlLm5vdygpLFxuICAgICAgZmlsdGVyczogSlNPTi5zdHJpbmdpZnkoZmlsdGVycylcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5rbmV4KCdicm9hZGNhc3Rfc2NoZWR1bGVzJykuaW5zZXJ0KHJvdylcbiAgfVxuXG4gIGFzeW5jIHVwZGF0ZVNjaGVkdWxlKHsgaWQsIGJvdElkLCBkYXRlLCB0aW1lLCB0aW1lem9uZSwgY29udGVudCwgdHlwZSwgZmlsdGVycyB9OiBTY2hlZHVsZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGRhdGVUaW1lID0gZGF0ZSArICcgJyArIHRpbWVcbiAgICBsZXQgdHMgPSB1bmRlZmluZWRcbiAgICBpZiAodGltZXpvbmUpIHtcbiAgICAgIHRzID0gbW9tZW50KG5ldyBEYXRlKGRhdGVUaW1lICsgJyAnICsgdGltZXpvbmUpKS50b0RhdGUoKVxuICAgIH1cblxuICAgIGNvbnN0IHJvdzogUGFydGlhbDxTY2hlZHVsZVJvdz4gPSB7XG4gICAgICBkYXRlX3RpbWU6IGRhdGVUaW1lLFxuICAgICAgdHM6IHRzID8gdGhpcy5rbmV4LmRhdGUuZm9ybWF0KHRzKSA6IHVuZGVmaW5lZCxcbiAgICAgIHRleHQ6IGNvbnRlbnQsXG4gICAgICB0eXBlOiB0eXBlLFxuICAgICAgZmlsdGVyczogSlNPTi5zdHJpbmdpZnkoZmlsdGVycylcbiAgICB9XG5cbiAgICBhd2FpdCB0aGlzLmtuZXgoJ2Jyb2FkY2FzdF9zY2hlZHVsZXMnKVxuICAgICAgLndoZXJlKHsgaWQsIGJvdElkLCBvdXRib3hlZDogdGhpcy5rbmV4LmJvb2wuZmFsc2UoKSB9KVxuICAgICAgLnVwZGF0ZShyb3cpXG4gIH1cblxuICBhc3luYyBkZWxldGVTY2hlZHVsZShpZDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgYXdhaXQgdGhpcy5rbmV4KCdicm9hZGNhc3Rfc2NoZWR1bGVzJylcbiAgICAgIC53aGVyZSh7IGlkIH0pXG4gICAgICAuZGVsZXRlKClcblxuICAgIGF3YWl0IHRoaXMua25leCgnYnJvYWRjYXN0X291dGJveCcpXG4gICAgICAud2hlcmUoeyBzY2hlZHVsZUlkOiBpZCB9KVxuICAgICAgLmRlbGV0ZSgpXG4gIH1cblxuICBhc3luYyBsaXN0U2NoZWR1bGVzKGJvdElkOiBzdHJpbmcpOiBQcm9taXNlPFNjaGVkdWxlUm93W10+IHtcbiAgICByZXR1cm4gdGhpcy5rbmV4KCdicm9hZGNhc3Rfc2NoZWR1bGVzJykud2hlcmUoeyBib3RJZCB9KVxuICB9XG5cbiAgYXN5bmMgZ2V0QnJvYWRjYXN0U2NoZWR1bGVzQnlUaW1lKGJvdElkOiBzdHJpbmcsIHVwY29taW5nRml4ZWRUaW1lLCB1cGNvbWluZ1ZhcmlhYmxlVGltZSk6IFByb21pc2U8U2NoZWR1bGVbXT4ge1xuICAgIHJldHVybiB0aGlzLmtuZXgoJ2Jyb2FkY2FzdF9zY2hlZHVsZXMnKVxuICAgICAgLndoZXJlKHtcbiAgICAgICAgYm90SWQsXG4gICAgICAgIG91dGJveGVkOiB0aGlzLmtuZXguYm9vbC5mYWxzZSgpXG4gICAgICB9KVxuICAgICAgLmFuZFdoZXJlKGZ1bmN0aW9uKCkge1xuICAgICAgICB0aGlzLndoZXJlKGZ1bmN0aW9uKCkge1xuICAgICAgICAgIHRoaXMud2hlcmVOb3ROdWxsKCd0cycpLmFuZFdoZXJlKHVwY29taW5nRml4ZWRUaW1lKVxuICAgICAgICB9KS5vcldoZXJlKGZ1bmN0aW9uKCkge1xuICAgICAgICAgIHRoaXMud2hlcmVOdWxsKCd0cycpLmFuZFdoZXJlKHVwY29taW5nVmFyaWFibGVUaW1lKVxuICAgICAgICB9KVxuICAgICAgfSlcbiAgfVxuXG4gIGFzeW5jIGdldFVzZXJzVGltZXpvbmUoKSB7XG4gICAgY29uc3QgYXR0cnMgPSBhd2FpdCB0aGlzLmtuZXgoJ3Nydl9jaGFubmVsX3VzZXJzJykuc2VsZWN0KCdhdHRyaWJ1dGVzJylcbiAgICBjb25zdCB0aW1lem9uZXMgPSBhdHRycy5tYXAoKHsgYXR0cmlidXRlczogeyB0aW1lem9uZSB9IH0pID0+IHRpbWV6b25lKVxuXG4gICAgcmV0dXJuIFsuLi5uZXcgU2V0KHRpbWV6b25lcyldXG4gIH1cblxuICBzZXRCcm9hZGNhc3RPdXRib3goYm90SWQsIHNjaGVkdWxlLCB0eikge1xuICAgIGNvbnN0IGluaXRpYWxUeiA9IHR6XG4gICAgY29uc3Qgc2lnbiA9IE51bWJlcih0eikgPj0gMCA/ICcrJyA6ICctJ1xuICAgIHR6ID0gcGFkRGlnaXRzKE1hdGguYWJzKE51bWJlcih0eikpLCAyKVxuICAgIGNvbnN0IHJlbFRpbWUgPSBtb21lbnQoYCR7c2NoZWR1bGVbJ2RhdGVfdGltZSddfSR7c2lnbn0ke3R6fWAsICdZWVlZLU1NLUREIEhIOm1tWicpLnRvRGF0ZSgpXG4gICAgY29uc3QgYWRqdXN0ZWRUaW1lID0gdGhpcy5rbmV4LmRhdGUuZm9ybWF0KHNjaGVkdWxlWyd0cyddID8gc2NoZWR1bGVbJ3RzJ10gOiByZWxUaW1lKVxuICAgIC8vIGNvbnN0IHdoZXJlQ2xhdXNlID0gXy5pc05pbChpbml0aWFsVHopXG4gICAgLy8gID8gJ3doZXJlIGF0dHJpYnV0ZXMtPnRpbWV6b25lIElTIE5VTEwnXG4gICAgLy8gIDogJ3doZXJlIGF0dHJpYnV0ZXMtPj50aW1lem9uZSA9IDppbml0aWFsVHonXG5cbiAgICBjb25zdCBzcWwgPSBgaW5zZXJ0IGludG8gYnJvYWRjYXN0X291dGJveCAoXCJ1c2VySWRcIiwgXCJzY2hlZHVsZUlkXCIsIFwiYm90SWRcIiwgXCJ0c1wiKVxuICAgICAgc2VsZWN0IHVzZXJJZCwgOnNjaGVkdWxlSWQsIDpib3RJZCwgOmFkanVzdGVkVGltZVxuICAgICAgZnJvbSAoXG4gICAgICAgIHNlbGVjdCBpZCBhcyB1c2VySWRcbiAgICAgICAgZnJvbSBzcnZfY2hhbm5lbF91c2Vyc1xuICAgICAgKSBhcyBxMWBcblxuICAgIHJldHVybiB0aGlzLmtuZXhcbiAgICAgIC5yYXcoc3FsLCB7XG4gICAgICAgIHNjaGVkdWxlSWQ6IHNjaGVkdWxlWydpZCddLFxuICAgICAgICBhZGp1c3RlZFRpbWUsXG4gICAgICAgIGluaXRpYWxUeixcbiAgICAgICAgYm90SWRcbiAgICAgIH0pXG4gICAgICAudGhlbigpXG4gIH1cblxuICBhc3luYyBnZXRPdXRib3hDb3VudChib3RJZDogc3RyaW5nLCBzY2hlZHVsZTogU2NoZWR1bGUpOiBQcm9taXNlPG51bWJlcj4ge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMua25leCgnYnJvYWRjYXN0X291dGJveCcpXG4gICAgICAud2hlcmUoeyBib3RJZCwgc2NoZWR1bGVJZDogc2NoZWR1bGUuaWQgfSlcbiAgICAgIC5jb3VudDxSZWNvcmQ8c3RyaW5nLCBudW1iZXI+PignKiBhcyBxdHknKVxuICAgICAgLmZpcnN0KClcbiAgICAgIC50aGVuKHJlc3VsdCA9PiByZXN1bHQhLnF0eSlcblxuICAgIHJldHVybiB0eXBlb2YgcmVzdWx0ID09PSAnbnVtYmVyJyA/IHJlc3VsdCA6IHBhcnNlSW50KHJlc3VsdClcbiAgfVxuXG4gIHVwZGF0ZVRvdGFsQ291bnQoc2NoZWR1bGU6IFNjaGVkdWxlLCBjb3VudDogbnVtYmVyKSB7XG4gICAgcmV0dXJuIHRoaXMua25leCgnYnJvYWRjYXN0X3NjaGVkdWxlcycpXG4gICAgICAud2hlcmUoeyBpZDogc2NoZWR1bGUuaWQgfSlcbiAgICAgIC51cGRhdGUoeyBvdXRib3hlZDogdGhpcy5rbmV4LmJvb2wudHJ1ZSgpLCB0b3RhbF9jb3VudDogY291bnQgfSlcbiAgfVxuXG4gIGFzeW5jIGdldEJyb2FkY2FzdE91dGJveChib3RJZDogc3RyaW5nKTogUHJvbWlzZTxCcm9hZGNhc3RbXT4ge1xuICAgIHJldHVybiB0aGlzLmtuZXgoJ2Jyb2FkY2FzdF9vdXRib3gnKVxuICAgICAgLndoZXJlUmF3KCdicm9hZGNhc3Rfb3V0Ym94LnRzIDwgPycsIFt0aGlzLmtuZXguZGF0ZS5ub3coKV0pXG4gICAgICAuYW5kV2hlcmUoJ2Jyb2FkY2FzdF9vdXRib3guYm90SWQnLCBib3RJZClcbiAgICAgIC5qb2luKCdzcnZfY2hhbm5lbF91c2VycycsICdzcnZfY2hhbm5lbF91c2Vycy5pZCcsICdicm9hZGNhc3Rfb3V0Ym94LnVzZXJJZCcpXG4gICAgICAuam9pbignYnJvYWRjYXN0X3NjaGVkdWxlcycsICdzY2hlZHVsZUlkJywgJ2Jyb2FkY2FzdF9zY2hlZHVsZXMuaWQnKVxuICAgICAgLmxpbWl0KDEwMDApXG4gICAgICAuc2VsZWN0KFtcbiAgICAgICAgJ3Nydl9jaGFubmVsX3VzZXJzLnVzZXJfaWQgYXMgdXNlcklkJyxcbiAgICAgICAgJ3Nydl9jaGFubmVsX3VzZXJzLmNoYW5uZWwgYXMgcGxhdGZvcm0nLFxuICAgICAgICAnYnJvYWRjYXN0X3NjaGVkdWxlcy50ZXh0IGFzIHRleHQnLFxuICAgICAgICAnYnJvYWRjYXN0X3NjaGVkdWxlcy50eXBlIGFzIHR5cGUnLFxuICAgICAgICAnYnJvYWRjYXN0X3NjaGVkdWxlcy5pZCBhcyBzY2hlZHVsZUlkJyxcbiAgICAgICAgJ2Jyb2FkY2FzdF9zY2hlZHVsZXMuZmlsdGVycyBhcyBmaWx0ZXJzJyxcbiAgICAgICAgJ2Jyb2FkY2FzdF9vdXRib3gudHMgYXMgc2VuZFRpbWUnLFxuICAgICAgICAnYnJvYWRjYXN0X291dGJveC51c2VySWQgYXMgc2NoZWR1bGVVc2VyJ1xuICAgICAgXSlcbiAgfVxuXG4gIGFzeW5jIGRlbGV0ZUJyb2FkY2FzdE91dGJveCh1c2VySWQ6IHN0cmluZywgc2NoZWR1bGVJZDogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIHRoaXMua25leCgnYnJvYWRjYXN0X291dGJveCcpXG4gICAgICAud2hlcmUoeyB1c2VySWQsIHNjaGVkdWxlSWQgfSlcbiAgICAgIC5kZWxldGUoKVxuICB9XG5cbiAgYXN5bmMgZGVsZXRlQnJvYWRjYXN0T3V0Ym94QnlJZChzY2hlZHVsZUlkOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICByZXR1cm4gdGhpcy5rbmV4KCdicm9hZGNhc3Rfb3V0Ym94JylcbiAgICAgIC53aGVyZSh7IHNjaGVkdWxlSWQgfSlcbiAgICAgIC5kZWxldGUoKVxuICB9XG5cbiAgYXN5bmMgaW5jcmVhc2VCcm9hZGNhc3RTZW50Q291bnQoaWQ6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLmtuZXgoJ2Jyb2FkY2FzdF9zY2hlZHVsZXMnKVxuICAgICAgLndoZXJlKHsgaWQgfSlcbiAgICAgIC51cGRhdGUoeyBzZW50X2NvdW50OiB0aGlzLmtuZXgucmF3KCdzZW50X2NvdW50ICsgMScpIH0pXG4gIH1cblxuICBhc3luYyB1cGRhdGVFcnJvckZpZWxkKHNjaGVkdWxlSWQ6IG51bWJlcik6IFByb21pc2U8dm9pZD4ge1xuICAgIHJldHVybiB0aGlzLmtuZXgoJ2Jyb2FkY2FzdF9zY2hlZHVsZXMnKVxuICAgICAgLndoZXJlKHsgaWQ6IHNjaGVkdWxlSWQgfSlcbiAgICAgIC51cGRhdGUoeyBlcnJvcmVkOiB0aGlzLmtuZXguYm9vbC50cnVlKCkgfSlcbiAgfVxufVxuIl19